(function(b){b.widget("mjs.nestedSortable",b.extend({},b.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",doNotClear:false,listType:"ol",maxLevels:0,protectRoot:false,rootID:null,rtl:false,isAllowed:function(){return true}},_create:function(){this.element.data("sortable",this.element.data("nestedSortable"));if(!this.element.is(this.options.listType))throw Error("nestedSortable: Please check the listType option is set to your actual list type");
return b.ui.sortable.prototype._create.apply(this,arguments)},destroy:function(){this.element.removeData("nestedSortable").unbind(".nestedSortable");return b.ui.sortable.prototype.destroy.apply(this,arguments)},_mouseDrag:function(c){this.position=this._generatePosition(c);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs)this.lastPositionAbs=this.positionAbs;var a=this.options;if(this.options.scroll){var d=false;if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!=
"HTML"){if(this.overflowOffset.top+this.scrollParent[0].offsetHeight-c.pageY<a.scrollSensitivity)this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop+a.scrollSpeed;else if(c.pageY-this.overflowOffset.top<a.scrollSensitivity)this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop-a.scrollSpeed;if(this.overflowOffset.left+this.scrollParent[0].offsetWidth-c.pageX<a.scrollSensitivity)this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft+a.scrollSpeed;else if(c.pageX-this.overflowOffset.left<
a.scrollSensitivity)this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft-a.scrollSpeed}else{if(c.pageY-b(document).scrollTop()<a.scrollSensitivity)d=b(document).scrollTop(b(document).scrollTop()-a.scrollSpeed);else if(b(window).height()-(c.pageY-b(document).scrollTop())<a.scrollSensitivity)d=b(document).scrollTop(b(document).scrollTop()+a.scrollSpeed);if(c.pageX-b(document).scrollLeft()<a.scrollSensitivity)d=b(document).scrollLeft(b(document).scrollLeft()-a.scrollSpeed);else if(b(window).width()-
(c.pageX-b(document).scrollLeft())<a.scrollSensitivity)d=b(document).scrollLeft(b(document).scrollLeft()+a.scrollSpeed)}d!==false&&b.ui.ddmanager&&!a.dropBehaviour&&b.ui.ddmanager.prepareOffsets(this,c)}this.positionAbs=this._convertPositionTo("absolute");d=this.placeholder.offset().top;if(!this.options.axis||this.options.axis!="y")this.helper[0].style.left=this.position.left+"px";if(!this.options.axis||this.options.axis!="x")this.helper[0].style.top=this.position.top+"px";for(var f=this.items.length-
1;f>=0;f--){var g=this.items[f],h=g.item[0],e=this._intersectsWithPointer(g);if(e)if(h!=this.currentItem[0]&&this.placeholder[e==1?"next":"prev"]()[0]!=h&&!b.contains(this.placeholder[0],h)&&(this.options.type=="semi-dynamic"?!b.contains(this.element[0],h):true)){b(h).mouseenter();this.direction=e==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(g)){b(h).mouseleave();this._rearrange(c,g)}else break;this._clearEmpty(h);this._trigger("change",c,this._uiHash());break}}f=
this.placeholder[0].parentNode.parentNode&&b(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?b(this.placeholder[0].parentNode.parentNode):null;g=this._getLevel(this.placeholder);h=this._getChildLevels(this.helper);e=this.placeholder[0].previousSibling?b(this.placeholder[0].previousSibling):null;if(e!=null)for(;e[0].nodeName.toLowerCase()!="li"||e[0]==this.currentItem[0]||e[0]==this.helper[0];)if(e[0].previousSibling)e=b(e[0].previousSibling);else{e=null;break}var i=this.placeholder[0].nextSibling?
b(this.placeholder[0].nextSibling):null;if(i!=null)for(;i[0].nodeName.toLowerCase()!="li"||i[0]==this.currentItem[0]||i[0]==this.helper[0];)if(i[0].nextSibling)i=b(i[0].nextSibling);else{i=null;break}var j=document.createElement(a.listType);this.beyondMaxLevels=0;if(f!=null&&i==null&&(a.rtl&&this.positionAbs.left+this.helper.outerWidth()>f.offset().left+f.outerWidth()||!a.rtl&&this.positionAbs.left<f.offset().left)){f.after(this.placeholder[0]);this._clearEmpty(f[0]);this._trigger("change",c,this._uiHash())}else if(e!=
null&&(a.rtl&&this.positionAbs.left+this.helper.outerWidth()<e.offset().left+e.outerWidth()-a.tabSize||!a.rtl&&this.positionAbs.left>e.offset().left+a.tabSize)){this._isAllowed(e,g,g+h+1);e.children(a.listType).length||e[0].appendChild(j);d&&d<=e.offset().top?e.children(a.listType).prepend(this.placeholder):e.children(a.listType)[0].appendChild(this.placeholder[0]);this._trigger("change",c,this._uiHash())}else this._isAllowed(f,g,g+h);this._contactContainers(c);b.ui.ddmanager&&b.ui.ddmanager.drag(this,
c);this._trigger("sort",c,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(c){if(this.beyondMaxLevels){this.placeholder.removeClass(this.options.errorClass);this.domPosition.prev?b(this.domPosition.prev).after(this.placeholder):b(this.domPosition.parent).prepend(this.placeholder);this._trigger("revert",c,this._uiHash())}for(var a=this.items.length-1;a>=0;a--)this._clearEmpty(this.items[a].item[0]);b.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(c){var a=
b.extend({},this.options,c);c=this._getItemsAsjQuery(a&&a.connected);var d=[];b(c).each(function(){var f=(b(a.item||this).attr(a.attribute||"id")||"").match(a.expression||/(.+)[-=_](.+)/),g=(b(a.item||this).parent(a.listType).parent(a.items).attr(a.attribute||"id")||"").match(a.expression||/(.+)[-=_](.+)/);if(f)d.push((a.key||f[1])+"["+(a.key&&a.expression?f[1]:f[2])+"]="+(g?a.key&&a.expression?g[1]:g[2]:a.rootID))});!d.length&&a.key&&d.push(a.key+"=");return d.join("&")},toHierarchy:function(c){function a(g){var h=
(b(g).attr(d.attribute||"id")||"").match(d.expression||/(.+)[-=_](.+)/);if(h){var e={id:h[2]};if(b(g).children(d.listType).children(d.items).length>0){e.children=[];b(g).children(d.listType).children(d.items).each(function(){var i=a(this);e.children.push(i)})}return e}}var d=b.extend({},this.options,c),f=[];b(this.element).children(d.items).each(function(){var g=a(this);f.push(g)});return f},toArray:function(c){function a(e,i,j){var k=j+1,l;if(b(e).children(d.listType).children(d.items).length>0){i++;
b(e).children(d.listType).children(d.items).each(function(){k=a(b(this),i,k)});i--}l=b(e).attr(d.attribute||"id").match(d.expression||/(.+)[-=_](.+)/);e=i===f+1?d.rootID:b(e).parent(d.listType).parent(d.items).attr(d.attribute||"id").match(d.expression||/(.+)[-=_](.+)/)[2];l&&g.push({item_id:l[2],parent_id:e,depth:i,left:j,right:k});return j=k+1}var d=b.extend({},this.options,c),f=d.startDepthCount||0,g=[],h=2;g.push({item_id:d.rootID,parent_id:"none",depth:f,left:"1",right:(b(d.items,this.element).length+
1)*2});b(this.element).children(d.items).each(function(){h=a(this,f+1,h)});return g=g.sort(function(e,i){return e.left-i.left})},_clearEmpty:function(c){c=b(c).children(this.options.listType);c.length&&!c.children().length&&!this.options.doNotClear&&c.remove()},_getLevel:function(c){var a=1;if(this.options.listType)for(c=c.closest(this.options.listType);c&&c.length>0&&!c.is(".ui-sortable");){a++;c=c.parent().closest(this.options.listType)}return a},_getChildLevels:function(c,a){var d=this,f=this.options,
g=0;a=a||0;b(c).children(f.listType).children(f.items).each(function(h,e){g=Math.max(d._getChildLevels(e,a+1),g)});return a?g+1:g},_isAllowed:function(c,a,d){var f=this.options,g=b(this.domPosition.parent).hasClass("ui-sortable")?true:false,h=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels");if(!f.isAllowed(this.currentItem,c)||c&&c.hasClass(f.disableNesting)||f.protectRoot&&(c==null&&!g||g&&a>1)){this.placeholder.addClass(f.errorClass);this.beyondMaxLevels=h<d&&h!=0?d-
h:1}else if(h<d&&h!=0){this.placeholder.addClass(f.errorClass);this.beyondMaxLevels=d-h}else{this.placeholder.removeClass(f.errorClass);this.beyondMaxLevels=0}}}));b.mjs.nestedSortable.prototype.options=b.extend({},b.ui.sortable.prototype.options,b.mjs.nestedSortable.prototype.options)})(jQuery);
